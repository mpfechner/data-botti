{% extends "base.html" %}
{% block content %}
<style>
  .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; max-width: 880px; background: #fff; }
  .row { display: flex; gap: 12px; align-items: center; }
  .row + .row { margin-top: 12px; }
  label { min-width: 150px; font-weight: 600; }
  select, input[type="text"], textarea { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
  button { padding: 10px 14px; border: 0; border-radius: 6px; cursor: pointer; }
  .primary { background: #3a6df0; color: #fff; }
  .hint { color: #555; font-size: 0.9rem; }
  .chip.active { background:#e8f4ff; }
</style>

<h2>Frage stellen</h2>
<form id="ask-form" method="post">
  {{ csrf_field() }}
  <div class="card">
    <div class="row">
      <label for="dataset_select">Dataset</label>
      <select id="dataset_select" name="dataset_id" required>
        <option value="">Bitte Dataset auswÃ¤hlenâ€¦</option>
        {% for ds in datasets %}
          <option value="{{ ds.id }}" data-file-hash="{{ ds.file_hash or '' }}" {% if selected_dataset_id and ds.id == selected_dataset_id %}selected{% endif %}>
            {{ ds.name or ('Dataset #' ~ ds.id) }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="row">
      <label for="prompt">Frage</label>
      <textarea id="prompt" name="prompt" rows="4" placeholder="Frag mich was zu deinem Datensatzâ€¦" required></textarea>
    </div>

    <div class="row">
      <label for="file_hash">Scope-Hash (optional)</label>
      <input id="file_hash" name="file_hash" type="text" placeholder="eigener Datei-Hash; leer = Standard-Hash des gewÃ¤hlten Datasets" />
    </div>

    <div class="row">
      <span class="hint">Hinweis: Wenn die Frage bereits fÃ¼r das gewÃ¤hlte Dataset existiert, wird die Antwort ðŸ’¾ aus dem Verlauf wiederverwendet.</span>
    </div>

    <div class="row" style="justify-content: flex-end;">
      <button class="primary" type="submit">Senden</button>
    </div>
  </div>

</form>

<div class="card" style="margin-top:20px;">
  <h3>Verlauf (letzte Fragen)</h3>
  <div class="chips" style="margin-top:4px; display:flex; gap:8px; align-items:center;">
    <span class="hint">Zeitraum:</span>
    {# default days to 'all' if not provided #}
    {% set _days = selected_days if selected_days is not none else 'all' %}
    <a class="chip{% if _days == '7' %} active{% endif %}" href="{{ url_for('assistant.search_page') }}?dataset_id={{ selected_dataset_id }}&days=7" style="padding:4px 10px; border-radius:14px; border:1px solid #cfe7ff; background:#fff; text-decoration:none;">7 Tage</a>
    <a class="chip{% if _days == '30' %} active{% endif %}" href="{{ url_for('assistant.search_page') }}?dataset_id={{ selected_dataset_id }}&days=30" style="padding:4px 10px; border-radius:14px; border:1px solid #cfe7ff; background:#fff; text-decoration:none;">30 Tage</a>
    <a class="chip{% if _days == 'all' %} active{% endif %}" href="{{ url_for('assistant.search_page') }}?dataset_id={{ selected_dataset_id }}" style="padding:4px 10px; border-radius:14px; border:1px solid #cfe7ff; background:#fff; text-decoration:none;">Alle</a>
  </div>
  {% if history and history|length > 0 %}
    <ul>
      {% for item in history %}
        <li style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
          <div>
            <strong title="{{ item.question_original }}">{{ item.question_original }}</strong>
            <span style="color:#555; font-size:0.9rem; margin-left:6px;">
              {{ item.created_at.strftime('%Y-%m-%d %H:%M') if item.created_at.__class__.__name__ != 'str' else item.created_at }}
            </span>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            {% if item.decision %}
              {% if item.decision == 'exact' %}
                <span class="chip" style="background:#e8f4ff;border:1px solid #cfe7ff;">ðŸ’¾ aus Verlauf</span>
              {% elif item.decision == 'analysis' %}
                <span class="chip" style="background:#e8fff0;border:1px solid #c7f0d8;">ðŸ“Š Analyse</span>
              {% elif item.decision in ['llm', 'semantic_or_llm'] %}
                <span class="chip" style="background:#f6f0ff;border:1px solid #e5d9ff;">âœ¨ neu generiert</span>
              {% endif %}
            {% endif %}
            <a class="btn btn-link" href="{{ url_for('assistant.show_qa', qa_id=item.id) }}" title="Antwort anzeigen">Antwort anzeigen</a>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="hint">Noch keine Fragen fÃ¼r dieses Dataset gestellt.</p>
  {% endif %}
</div>

<script>
  const form = document.getElementById('ask-form');
  const sel = document.getElementById('dataset_select');
  const fileHashInput = document.getElementById('file_hash');

  // Wenn kein eigener Scope-Hash eingegeben wird, kann (optional) der Standard-Hash des Datasets verwendet werden
  sel.addEventListener('change', () => {
    const opt = sel.options[sel.selectedIndex];
    const defaultHash = opt ? opt.getAttribute('data-file-hash') : '';
    if (!fileHashInput.value && defaultHash) {
      // Hinweis: wir fÃ¼llen NICHT automatisch, lassen aber die Info im title
      fileHashInput.placeholder = `leer = Standard-Hash (${defaultHash})`;
      fileHashInput.title = `Standard-Hash des Datasets: ${defaultHash}`;
    } else {
      fileHashInput.placeholder = 'eigener Datei-Hash; leer = Standard-Hash des gewÃ¤hlten Datasets';
      fileHashInput.title = '';
    }
    // Reload /search with ?dataset_id=<id> to populate history for the chosen dataset
    const selectedId = sel.value;
    if (selectedId) {
      const url = new URL(window.location.href);
      url.searchParams.set('dataset_id', selectedId);
      window.location.href = url.toString();
    }
  });

  form.addEventListener('submit', function (e) {
    const ds = sel.value.trim();
    if (!ds) { e.preventDefault(); alert('Bitte ein Dataset auswÃ¤hlen.'); return; }
    // Zielroute dynamisch auf /ai/<dataset_id>
    form.action = `/ai/${encodeURIComponent(ds)}`;
  });
</script>
{% endblock %}