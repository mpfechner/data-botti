{% extends "base.html" %}
{% block title %}Admin · Gruppen{% endblock %}

{% block content %}
<div class="container">
  <h1 class="page-title">Admin · Gruppen</h1>

  <div class="btn-switch mb-3">
    <a class="btn btn-db-outline" href="{{ url_for('admin.list_users') }}">Benutzer</a>
    <a class="btn btn-db" href="{{ url_for('admin.list_groups') }}">Gruppen</a>
  </div>

  <section class="card">
    <h2 class="card-title">Gruppe erstellen</h2>
    <form method="post" action="{{ url_for('admin.create_group') }}" class="form">
      {{ csrf_field() }}
      <div class="form-grid">
        <label for="name" class="form-label">Name</label>
        <input id="name" name="name" type="text" class="form-control" required>
        <div class="form-actions">
          <button class="btn btn-primary" type="submit">Erstellen</button>
        </div>
      </div>
    </form>
  </section>

  <section class="card">
    <h2 class="card-title">Alle Gruppen</h2>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Mitglieder</th>
            <th class="text-end">Aktionen</th>
          </tr>
        </thead>
        <tbody>
          {% for g in groups %}
          <tr>
            <td>{{ g.id }}</td>
            <td>{{ g.name }}</td>
            <td>
              <div class="members">
                {% set g_members = members.get(g.id, []) %}
                {% if g_members %}
                  <ul class="list-inline">
                    {% for m in g_members %}
                      <li>
                        <span class="badge">{{ m.username or m.email }}</span>
                        <form method="post" action="{{ url_for('admin.remove_user_from_group', group_id=g.id) }}">
                          {{ csrf_field() }}
                          <input type="hidden" name="user_id" value="{{ m.id }}">
                          <button class="btn btn-xsmall" type="submit" title="Entfernen">×</button>
                        </form>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <span class="muted">Keine Mitglieder</span>
                {% endif %}
              </div>

              <form method="post" action="{{ url_for('admin.add_user_to_group', group_id=g.id) }}" class="form add-member-form">
                {{ csrf_field() }}
                <select name="user_id" class="form-select" required>
                  <option value="" disabled selected>+ Mitglied hinzufügen…</option>
                  {% for u in users %}
                    {% if not g_members or (u.id not in (g_members | map(attribute='id'))) %}
                      <option value="{{ u.id }}">{{ u.username or u.email }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
                <button class="btn btn-secondary" type="submit">Hinzufügen</button>
              </form>
            </td>
            <td class="text-end">
              <form method="post" action="{{ url_for('admin.delete_group', group_id=g.id) }}" onsubmit="return confirm('Diese Gruppe wirklich löschen?');">
                {{ csrf_field() }}
                <button class="btn btn-danger" type="submit">Löschen</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="4" class="muted">Keine Gruppen gefunden.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock %}